#include <SoftwareSerial.h>
#include <LiquidCrystal_I2C.h>
#include <XBee.h>

#define RX_PIN 4  
#define TX_PIN 5  

SoftwareSerial XBeeSerial(RX_PIN, TX_PIN);  
LiquidCrystal_I2C lcd(0x27, 20, 4);

XBee xbee = XBee();
ZBRxResponse rx = ZBRxResponse();
ModemStatusResponse msr = ModemStatusResponse();

String status = "On";

void setup() {
  Serial.begin(9600);
  XBeeSerial.begin(9600);
  xbee.setSerial(XBeeSerial);  // attach SoftwareSerial to XBee object

  pinMode(7, OUTPUT); 
  pinMode(8, OUTPUT);
  pinMode(9, OUTPUT);
  pinMode(10, OUTPUT);

  Serial.println("Waiting for XBee data...");

  lcd.init();
  lcd.backlight();
}

void loop() {
  lcd.setCursor(3, 0);
  lcd.print("Control Device      ");  // pad with spaces to clear line
  lcd.setCursor(0, 1);
  lcd.print(status + "         ");      // pad with spaces to clear line

  xbee.readPacket();

  if (xbee.getResponse().isAvailable()) {
    if (xbee.getResponse().getApiId() == ZB_RX_RESPONSE) {
      xbee.getResponse().getZBRxResponse(rx);

      // Get the payload as a string
      int dataLen = rx.getDataLength();
      String receivedData = "";

      for (int i = 0; i < dataLen; i++) {
        receivedData += (char)rx.getData()[i];
      }

      receivedData.trim();  // clean up spaces/newlines

      Serial.print("Received: ");
      Serial.println(receivedData);

      if (receivedData == "CS") {
        digitalWrite(7, HIGH);
        status = "Off";
        lcd.setCursor(0, 1);
        lcd.print(status + "         ");
      }
      else if (receivedData == "RS") {
        digitalWrite(7, LOW);
        status = "On";
        lcd.setCursor(0, 1);
        lcd.print(status + "         ");
      }
    }
    else if (xbee.getResponse().getApiId() == MODEM_STATUS_RESPONSE) {
      xbee.getResponse().getModemStatusResponse(msr);
      Serial.print("Modem status: ");
      Serial.println(msr.getStatus(), HEX);
    }
    else {
      Serial.println("Other API frame received.");
    }
  }
  else if (xbee.getResponse().isError()) {
    Serial.print("Error reading packet. Error code: ");
    Serial.println(xbee.getResponse().getErrorCode());
  }
}
